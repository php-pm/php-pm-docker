FROM alpine:3.15

ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8

RUN apk --no-cache add tzdata && \
    cp /usr/share/zoneinfo/Etc/UTC /etc/localtime && \
    echo "UTC" | tee /etc/timezone && \
    apk del tzdata

RUN apk --no-cache add \
    php8 php8-opcache php8-fpm php8-cgi php8-ctype php8-json php8-dom php8-zip php8-zip php8-gd \
    php8-curl php8-mbstring php8-redis php8-iconv php8-posix php8-pdo_mysql php8-tokenizer php8-simplexml php8-session \
    php8-xml php8-sockets php8-openssl php8-fileinfo php8-ldap php8-exif php8-pcntl php8-xmlwriter php8-phar php8-zlib \
    php8-intl php8-pcntl
ADD etc/php.ini /etc/php8/php.ini
RUN ln -s /usr/bin/php8 /usr/bin/php

RUN apk --no-cache add nginx bash
ADD etc/nginx_default.conf /etc/nginx/sites-enabled/default
ADD etc/nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

ARG PHP_PM_VERSION=dev-master
ARG PHP_PM_HTTP_VERSION=dev-master
ARG COMPOSER_VERSION=2.3

WORKDIR /ppm

COPY --from=composer:${COMPOSER_VERSION} /usr/bin/composer /usr/bin/composer

RUN composer require php-pm/php-pm:${PHP_PM_VERSION} && composer require php-pm/httpkernel-adapter:${PHP_PM_HTTP_VERSION}

WORKDIR /var/www

ADD run-nginx.sh /etc/app/run.sh
ENTRYPOINT ["/bin/bash", "/etc/app/run.sh"]
